<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link rel="stylesheet" th:href="@{/css/cart.css}" href="css/cart.css" type="text/css" />
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300&display=swap" rel="stylesheet">
<link rel="stylesheet" th:href="@{/js/calendario/src/calendarjs.css}" href="/js/calendario/src/calendarjs.css"
    type="text/css" />
<script th:src="@{/js/calendario/src/calendarjs.js}" src="/js/calendario/src/calendarjs.js"></script>

<head>
    <th:block th:replace="fragments/header.html :: header" />
    <title>Carrito</title>
</head>

<body>
    <header th:replace="fragments/cabecera.html :: cabecera">
        Header goes here
    </header>
    <nav th:replace="fragments/nav.html :: nav">
        Nav goes here
    </nav>

    <div class="contenedor_productos">
        <form class="cart">
            <div class="cartProds">
                <table>
                    <tr>
                        <th>Diseño</th>
                        <th>Precio</th>
                    </tr>
                    <div th:if="${products.size() == 0}">
                        <p>Tu cesta está vacía</p>
                    </div>
                    <!-- <div th:each="p:${products}" class="apartado"> -->
                    <tr th:each="p:${products}" th:id="${p[6]}">
                        <!-- <div class="prod" th:id="${p[6]}"> -->
                            <td class="nombre" th:text="${p[5]}" th:value="${p[5]}"></td>
                            <td class="priceProd" th:text="${p[2]}" th:value="${p[2]}"></td>
                            <td>
                                <form method="POST" th:action="@{/sale/delProduct/}">
                                    <input type="hidden" th:value="${p[6]}">
                                    <button type="submit" th:id="${p[6]}" class="x">X</button>
                                </form>
                            </td>
                            <td th:if="${printer != null}" th:text="${printerPrice + ' €'}"></td>
                            <td><img th:if="${printer != null}" th:src="@{/img/printer.png}" height="30"
                                    width="30" th:alt="${printer}"></td>

                        <!-- </div> -->
                    </tr>
                    <!-- </div> -->
                </table>
                <hr>
                <p id="sumPrice" th:if="${products.size() > 0}" class="total">Total
                    <span class="price" style="color:black">
                        <b class="totalPrice" id="priceTotal" th:text="${price}" th:value="${price}"></b>
                    </span>
                </p>

            </div>

            <div th:if="${products.size() > 0}" class="dropdown">
                <button id="drop" class="dropbtn">Añadir impresora</button>
                <div class="dropdown-content">
                    <a th:each="pr: ${printers}" th:href="@{/sale/printerChoice/{id}/(id=${pr.id})}" th:id="kaka"
                        th:text="${pr.name + ' ' + pr.precio + '€'}"></a>
                </div>
            </div>

            <div th:if="${products.size() > 0}" id="fin">
                <h3 th:text="@{Tu pedido ha sido reservado para:} + ${evento}"></h3>
            </div>

            <div th:if="${products.size() > 0}" id="fin">
                <a th:if="${session.u.saleId}" th:href="@{/sale/{id}/payments/(id=${session.u.saleId.id})}"
                    class="input" id="boton">Tramitar</a>
            </div>
        </form>
    </div>



    <footer th:replace="fragments/footer.html :: footer">
        Footer goes here
    </footer>

    <script>
        $(".x").on('click', function (e) {
            let id = this.parentElement.children[1].value;
            //let id = $(".prod").attr("id");
            let pr = $(".priceProd").attr("value");

            let total = $(".totalPrice").attr("value");
            let fin = total - pr;

            var box = document.getElementById(id);
            console.log(box);
            while (box.firstChild) {
                box.removeChild(box.firstChild);
            }
            document.getElementById("priceTotal").innerHTML = fin;
            e.preventDefault(); // <-- evita que se envíe de la forma normal
            go("/sale/delProduct/", 'POST', // <-- hace el `fetch`, y recibe resultados
                { prodId: id, price: pr })
                .then(d => { console.log("happy", d); })
                .catch(e => console.log("sad", e))
        });
    </script>

</body>

</html>